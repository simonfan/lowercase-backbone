//     lowercase-backbone
//     (c) simonfan
//     lowercase-backbone is licensed under the MIT terms.

define("lowercase-backbone",["require","exports","module","subject","backbone","lodash"],function(e,t,i){var o=e("subject"),s=e("backbone"),n=e("lodash"),r=i.exports={},l=r.model=o(s.Model.prototype);r.model.proto({initialize:function(){this.initializeBackboneModel.apply(this,arguments)},initializeBackboneModel:function(e,t){var i=e||{};t||(t={}),this.cid=n.uniqueId("c"),this.attributes={},t.collection&&(this.collection=t.collection),t.parse&&(i=this.parse(i,t)||{}),i=n.defaults({},i,n.result(this,"defaults")),this.set(i,t),this.changed={}}});var a={add:!0,remove:!0,merge:!0};r.collection=o(s.Collection.prototype),r.collection.proto({initialize:function(){this.initializeBackboneCollection.apply(this,arguments)},initializeBackboneCollection:function(e,t){t||(t={}),t.model&&(this.model=t.model),void 0!==t.comparator&&(this.comparator=t.comparator),this._reset(),e&&this.reset(e,n.extend({silent:!0},t))},_prepareModel:function(e,t){if(e instanceof l)return e;t=t?n.clone(t):{},t.collection=this;var i=new this.model(e,t);return i.validationError?(this.trigger("invalid",this,i.validationError,t),!1):i},set:function(e,t){t=n.defaults({},t,a),t.parse&&(e=this.parse(e,t));var i=!n.isArray(e);e=i?e?[e]:[]:n.clone(e);var o,s,r,h,c,d,u,p=t.at,f=this.model,m=this.comparator&&null==p&&t.sort!==!1,g=n.isString(this.comparator)?this.comparator:null,b=[],v=[],k={},z=t.add,y=t.merge,w=t.remove,B=!m&&z&&w?[]:!1;for(o=0,s=e.length;s>o;o++){if(c=e[o]||{},r=c instanceof l?h=c:c[f.prototype.idAttribute||"id"],d=this.get(r))w&&(k[d.cid]=!0),y&&(c=c===h?h.attributes:c,t.parse&&(c=d.parse(c,t)),d.set(c,t),m&&!u&&d.hasChanged(g)&&(u=!0)),e[o]=d;else if(z){if(h=e[o]=this._prepareModel(c,t),!h)continue;b.push(h),this._addReference(h,t)}h=d||h,!B||!h.isNew()&&k[h.id]||B.push(h),k[h.id]=!0}if(w){for(o=0,s=this.length;s>o;++o)k[(h=this.models[o]).cid]||v.push(h);v.length&&this.remove(v,t)}if(b.length||B&&B.length)if(m&&(u=!0),this.length+=b.length,null!=p)for(o=0,s=b.length;s>o;o++)this.models.splice(p+o,0,b[o]);else{B&&(this.models.length=0);var _=B||b;for(o=0,s=_.length;s>o;o++)this.models.push(_[o])}if(u&&this.sort({silent:!0}),!t.silent){for(o=0,s=b.length;s>o;o++)(h=b[o]).trigger("add",h,this,t);(u||B&&B.length)&&this.trigger("sort",this,t)}return i?e[0]:e}});var h=["model","collection","el","id","attributes","className","tagName","events"];r.view=o(s.View.prototype),r.view.proto({initialize:function(e){this.initializeBackboneView(e)},initializeBackboneView:function(e){this.cid=n.uniqueId("view"),e||(e={}),n.extend(this,n.pick(e,h)),this._ensureElement(),this.delegateEvents()}}),r.router=o(s.Router.prototype),r.router.proto({initialize:function(){this.initializeBackboneRouter.apply(this,arguments)},initializeBackboneRouter:function(e){e||(e={}),e.routes&&(this.routes=e.routes),this._bindRoutes()}}),r.history=s.history});